<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‘µç²‰å‹•èµ·ä¾†</title>
    <meta property="og:title" content="è‘µç²‰å‹•èµ·ä¾†">
    <meta property="og:image" content="https://i.postimg.cc/WbcnW6XV/002-kui-fen-dong-qi-lai-vivipic-(3).jpg">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --line-green: #06C755; --kewi-pink: #FF85A2; --bg-gray: #F4F6F9; }
        body { font-family: sans-serif; background: var(--bg-gray); margin: 0; padding: 0; }
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #ffffff; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
        .svg-heart { width: 70px; height: 70px; fill: var(--kewi-pink); animation: pulse 1.2s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1.1); } 50% { transform: scale(1.3); } }
        .header { background: linear-gradient(135deg, var(--line-green), #05a346); padding: 30px 20px; text-align: center; color: white; border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; }
        .avatar { width: 70px; height: 70px; border-radius: 50%; border: 2px solid #fff; object-fit: cover; }
        .points-val { font-size: 50px; font-weight: 800; margin: 5px 0; }
        .container { max-width: 450px; margin: -30px auto 40px; padding: 0 15px; }
        .card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); margin-bottom: 15px; }
        
        .product-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; max-height: 200px; overflow-y: auto; padding: 10px; border: 1px solid #eee; border-radius: 12px; background: #fafafa; }
        .product-item { display: flex; align-items: center; background: white; padding: 10px; border-radius: 8px; border: 1px solid #eee; font-size: 13px; }
        .product-item input { margin-right: 8px; width: 18px; height: 18px; accent-color: var(--line-green); }
        
        .btn-main { background: #333; color: white; border: none; padding: 16px; width: 100%; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-submit { background: var(--line-green); margin-top: 15px; display: none; }
        
        /* å¤šåœ–é è¦½å€ */
        #preview-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 15px; display: none; }
        .preview-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; border-radius: 8px; border: 1px solid #eee; }

        .rewards-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .reward-card { background: #fff; border: 1px solid #eee; border-radius: 15px; padding: 10px; text-align: center; }
        .reward-name { font-size: 11px; height: 32px; overflow: hidden; font-weight: bold; margin-bottom: 6px; display: flex; align-items: center; justify-content: center; }
        .reward-img { width: 100%; aspect-ratio: 1 / 1; border-radius: 10px; object-fit: cover; background: #f9f9f9; }
        .progress-info { display: flex; justify-content: space-between; font-size: 10px; font-weight: bold; color: #333; margin: 4px 0; }
        .progress-bg { background: #eee; height: 7px; border-radius: 4px; overflow: hidden; }
        .progress-fill { background: var(--line-green); height: 100%; width: 0%; transition: width 0.6s; }
    </style>
</head>
<body>

<div id="loading-screen">
    <svg class="svg-heart" viewBox="0 0 32 32"><path d="M16 28.5L14.1 26.8C7.33 20.62 3 16.66 3 11.85C3 7.84 6.09 4.75 10 4.75C12.21 4.75 14.33 5.79 15.7 7.44C15.81 7.57 15.91 7.71 16 7.85C16.09 7.71 16.19 7.57 16.3 7.44C17.67 5.79 19.79 4.75 22 4.75C25.91 4.75 29 7.84 29 11.85C29 16.66 24.67 20.62 17.9 26.82L16 28.5Z"/></svg>
</div>

<div id="main-app" style="display:none;">
    <div class="header">
        <img id="user-avatar" class="avatar" src="">
        <div id="user-name" style="margin-top:5px; font-size:18px;">è‘µç²‰</div>
        <div class="points-val" id="points-display">--</div>
    </div>
    <div class="container">
        <div class="card">
            <div style="font-weight:bold; margin-bottom:10px; font-size:15px; text-align:left;"><i class="fas fa-check-square"></i> 1. å‹¾é¸ä»Šæ—¥æ‰“å¡å•†å“(å¯æ»‘å‹•,å¯è¤‡é¸)</div>
            <div id="product-grid" class="product-grid">è¼‰å…¥ä¸­...</div>
            
            <div style="font-weight:bold; margin-bottom:10px; margin-top:20px; font-size:15px; text-align:left;"><i class="fas fa-images"></i> 2. ä¸Šå‚³æˆªåœ– (å¯å¤šé¸)</div>
            <input type="file" id="file-input" accept="image/*" multiple style="display:none">
            <button id="upload-btn" class="btn-main" onclick="document.getElementById('file-input').click()">ğŸ“¸ é¸å–ç…§ç‰‡</button>
            <div id="preview-container"></div>
            <button id="submit-btn" class="btn-main btn-submit" onclick="handleSubmit()">ğŸš€ ç¢ºèªé€å‡ºæ‰“å¡</button>
        </div>
        <div class="card" style="text-align:left;">
            <div style="font-weight:bold; margin-bottom:12px;">ğŸ VIPé›†é»æ›å¥½ç¦®</div>
            <div id="rewards-grid" class="rewards-grid">è¼‰å…¥ä¸­...</div>
        </div>
    </div>
</div>

<script>
    const LIFF_ID = "2008852092-FWAMmdWd";
    const GAS_URL = "https://script.google.com/macros/s/AKfycbydAUJv9hkMsWFuFNTMoSQ61Md67yE-LyjTh4bg8U97NPgyG2ZvkdY_flflAcBxd4ol/exec";
    let userId = "", userName = "", productPtsMap = {}, selectedFiles = [];

    window.onload = async function() {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }
            const p = await liff.getProfile();
            userId = p.userId; userName = p.displayName;
            document.getElementById("user-name").innerText = userName;
            document.getElementById("user-avatar").src = p.pictureUrl || "";
            await fetchData();
            document.getElementById("loading-screen").style.display = "none";
            document.getElementById("main-app").style.display = "block";
        } catch (e) { alert("é€£ç·šå¤±æ•—"); }
    };

    async function fetchData() {
        const res = await fetch(`${GAS_URL}?userId=${userId}`);
        const data = await res.json();
        document.getElementById("points-display").innerText = data.points;
        const grid = document.getElementById("product-grid");
        grid.innerHTML = data.productList.map(item => {
            productPtsMap[item.name] = item.pts;
            return `<label class="product-item"><input type="checkbox" name="prod" value="${item.name}">${item.name}</label>`;
        }).join("");
        const rGrid = document.getElementById("rewards-grid");
        rGrid.innerHTML = data.rewards.map(r => {
            let p = Math.min((data.points / r.required) * 100, 100);
            return `<div class="reward-card"><div class="reward-name">${r.name}</div><img src="${r.image || 'https://via.placeholder.com/150'}" class="reward-img"><div class="progress-info"><span>${data.points}</span><span>ç›®æ¨™${r.required}</span></div><div class="progress-bg"><div class="progress-fill" style="width:${p}%"></div></div></div>`;
        }).join("");
    }

    document.getElementById('file-input').onchange = (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;
        selectedFiles = files;
        const container = document.getElementById('preview-container');
        container.innerHTML = "";
        container.style.display = "grid";
        
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                const img = document.createElement('img');
                img.src = ev.target.result;
                img.className = "preview-img";
                container.appendChild(img);
            };
            reader.readAsDataURL(file);
        });
        document.getElementById('submit-btn').style.display = 'block';
    };

    function compressImage(img) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const maxW = 600;
        const scale = maxW / img.width;
        canvas.width = maxW; canvas.height = img.height * scale;
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        return canvas.toDataURL('image/jpeg', 0.4); // é™ä½ä¸€é»å“è³ªä»¥æ‡‰å°å¤šåœ–å‚³è¼¸
    }

    async function handleSubmit() {
        const selectedProds = Array.from(document.querySelectorAll('input[name="prod"]:checked')).map(el => el.value);
        if (selectedProds.length === 0) { alert("è«‹è‡³å°‘å‹¾é¸ä¸€å€‹å•†å“ï¼"); return; }
        if (selectedFiles.length === 0) { alert("è«‹é¸å–æˆªåœ–ï¼"); return; }
        
        const btn = document.getElementById("submit-btn");
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> è¾¨è­˜ä¸­...';

        const compressedImages = [];
        for (const file of selectedFiles) {
            const img = new Image();
            img.src = await new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.readAsDataURL(file);
            });
            await img.decode();
            compressedImages.push(compressImage(img));
        }

        try {
            const res = await fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify({
                    userId, userName,
                    selectedProducts: selectedProds,
                    productPtsMap: productPtsMap,
                    images: compressedImages,
                    date: new Date().toLocaleDateString('en-CA')
                })
            });
            const resData = await res.json();
            alert(resData.message);
            if (resData.newPoints !== undefined) {
                document.getElementById("points-display").innerText = resData.newPoints;
                fetchData();
            }
            // é‡ç½®
            document.getElementById('preview-container').innerHTML = '';
            document.getElementById('file-input').value = '';
            document.querySelectorAll('input[name="prod"]').forEach(cb => cb.checked = false);
            btn.style.display = 'none'; btn.disabled = false; btn.innerHTML = 'ğŸš€ ç¢ºèªé€å‡ºæ‰“å¡';
        } catch (e) { alert("ä¸Šå‚³å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦"); btn.disabled = false; }
    }
</script>
</body>
</html>
